name: Upstream Sync

on:
  schedule:
    # Run daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  check-upstream:
    name: Check for upstream changes
    runs-on: ubuntu-latest
    permissions:
      contents: write       # needed to push the sync branch to this repo
      pull-requests: write  # needed to create the sync PR in this repo

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get last synced commit
        id: last-sync
        run: echo "sha=$(cat .last-sync-commit | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"

      - name: Get latest upstream commit
        id: upstream
        run: |
          # git ls-remote reads public repos without any auth or API calls
          LATEST=$(git ls-remote https://github.com/mapbox/earcut.git refs/heads/main | cut -f1)
          if [ -z "$LATEST" ]; then
            echo "::error::Could not resolve latest upstream commit SHA"
            exit 1
          fi
          echo "sha=$LATEST" >> "$GITHUB_OUTPUT"
          echo "Latest upstream commit: $LATEST"

      - name: Clone upstream and create sync PR
        if: steps.last-sync.outputs.sha != steps.upstream.outputs.sha
        env:
          # GH_TOKEN is required here for write operations on THIS repository:
          # creating the sync branch, the auto-sync label, and the pull request.
          # It does NOT need any additional configuration — GitHub provides it automatically.
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LAST="${{ steps.last-sync.outputs.sha }}"
          LATEST="${{ steps.upstream.outputs.sha }}"
          BRANCH="auto-sync/upstream-${LATEST:0:7}"
          DATE=$(date -u +"%Y-%m-%d")

          echo "Upstream has new commits since ${LAST:0:7} (latest: ${LATEST:0:7})"

          # Clone the full upstream repo with enough depth to cover the commit range
          git clone --depth 50 https://github.com/mapbox/earcut.git /tmp/earcut-upstream

          # Build commit list using git log — no API calls needed
          COMMITS=$(git -C /tmp/earcut-upstream log \
            --pretty=format:"- [%h](https://github.com/mapbox/earcut/commit/%H) %s" \
            "${LAST}..${LATEST}" 2>/dev/null)
          [ -z "$COMMITS" ] && COMMITS="- (commit history not available in shallow clone)"

          # Set up git identity for commits to this repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"

          # Update sync marker
          echo "$LATEST" > .last-sync-commit

          # Mirror the entire upstream repo into .upstream/ for side-by-side reference
          rm -rf .upstream
          cp -r /tmp/earcut-upstream .upstream
          rm -rf .upstream/.git

          git add .last-sync-commit .upstream/
          git commit -m "chore: sync upstream earcut to ${LATEST:0:7}

Upstream commits since ${LAST:0:7}:
$COMMITS"
          git push origin "$BRANCH"

          # Ensure the auto-sync label exists in this repo
          gh label create "auto-sync" \
            --description "Automatically generated upstream sync PR" \
            --color "0075ca" 2>/dev/null || true

          gh pr create \
            --title "chore: sync upstream earcut changes (${LATEST:0:7}) — ${DATE}" \
            --label "auto-sync" \
            --base main \
            --head "$BRANCH" \
            --body "## Upstream Sync

This PR was automatically generated by the [Upstream Sync workflow](.github/workflows/upstream-sync.yml).

**Upstream repository:** https://github.com/mapbox/earcut
**Previous synced commit:** [\`${LAST:0:7}\`](https://github.com/mapbox/earcut/commit/${LAST})
**New upstream commit:** [\`${LATEST:0:7}\`](https://github.com/mapbox/earcut/commit/${LATEST})
**Compare:** https://github.com/mapbox/earcut/compare/${LAST}...${LATEST}

### Upstream commits included

$COMMITS

### What to do

The complete upstream repository has been mirrored into \`.upstream/\` for side-by-side reference:

1. Review the diff: https://github.com/mapbox/earcut/compare/${LAST}...${LATEST}
2. Port algorithm changes from \`.upstream/src/earcut.js\` to \`src/Earcut/Earcut.cs\` using [PORTING_GUIDE.md](PORTING_GUIDE.md).
3. Sync any changed test fixtures from \`.upstream/test/\` to \`test/Earcut.Tests/fixtures/\` and update \`test/Earcut.Tests/expected.json\`.
4. Run \`dotnet test\` and ensure all tests pass.
5. Update \`PORTING_GUIDE.md\` if new language patterns were introduced.

> [!NOTE]
> GitHub Copilot coding agent can be invoked on this PR to assist with porting the JS changes to C#."
